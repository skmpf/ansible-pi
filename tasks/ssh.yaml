---
- name: Backup SSH configuration
  become: true
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.bak
    remote_src: yes
    backup: yes

- name: Apply SSH hardening settings
  become: true
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: "Port", line: "Port {{ ssh_port }}" }
    - { regexp: "Protocol", line: "Protocol 2" }
    - { regexp: "PermitRootLogin", line: "PermitRootLogin no" }
    - { regexp: "PasswordAuthentication", line: "PasswordAuthentication no" }
    - { regexp: "PermitEmptyPasswords", line: "PermitEmptyPasswords no" }
    - regexp: "PubkeyAuthentication"
      line: "PubkeyAuthentication yes"
    - { regexp: "MaxAuthTries", line: "MaxAuthTries 3" }
    - { regexp: "MaxStartups", line: "MaxStartups 10:30:60" }
    - { regexp: "ClientAliveInterval", line: "ClientAliveInterval 300" }
    - { regexp: "ClientAliveCountMax", line: "ClientAliveCountMax 2" }
    - { regexp: "UsePAM", line: "UsePAM yes" }
    - { regexp: "X11Forwarding", line: "X11Forwarding no" }
    - { regexp: "AllowTcpForwarding", line: "AllowTcpForwarding no" }

- name: Test SSH configuration syntax
  become: true
  ansible.builtin.command: sshd -t
  register: sshd_test
  changed_when: false

- name: Restart SSH service to apply changes
  become: true
  ansible.builtin.systemd:
    name: ssh
    state: restarted
    enabled: yes
  when: sshd_test.rc == 0

- name: Verify SSH is listening
  ansible.builtin.wait_for:
    port: "{{ ssh_port }}"
    delay: 5
    timeout: 15
