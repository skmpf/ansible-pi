---
- name: Install Docker
  block:
    - name: Check if Docker is already installed
      ansible.builtin.command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Ensure apt cache is updated
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: docker_check.rc != 0

    - name: Install Docker from default repositories
      ansible.builtin.apt:
        name: docker.io
        state: present
      when: docker_check.rc != 0

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Ensure Docker service is enabled and started
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

  rescue:
    - name: Docker installation failed
      ansible.builtin.debug:
        msg: "Failed to install Docker. Please check the error messages above."

    - name: Fail the playbook
      ansible.builtin.fail:
        msg: "Docker installation failed"
